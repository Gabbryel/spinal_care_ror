<% if access %>
  <div class="analytics-dashboard-new" data-controller="analytics-refresh" data-analytics-refresh-interval-value="1200000">
    <!-- Header -->
    <div class="analytics-header-new">
      <div>
        <h1 class="analytics-title">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="title-icon">
            <path fill-rule="evenodd" d="M2.25 13.5a8.25 8.25 0 018.25-8.25.75.75 0 01.75.75v6.75H18a.75.75 0 01.75.75 8.25 8.25 0 01-16.5 0z" clip-rule="evenodd" />
            <path fill-rule="evenodd" d="M12.75 3a.75.75 0 01.75-.75 8.25 8.25 0 018.25 8.25.75.75 0 01-.75.75h-7.5a.75.75 0 01-.75-.75V3z" clip-rule="evenodd" />
          </svg>
          Analytics Dashboard
        </h1>
        <p class="analytics-subtitle">Performanță în timp real</p>
      </div>
      <%= link_to dashboard_path, class: 'btn-back-new' do %>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
        </svg>
        Înapoi
      <% end %>
    </div>

    <!-- Period Filter -->
    <div class="period-filter-new" role="region" aria-label="Filtru perioadă">
      <%= form_with url: dashboard_analytics_path, method: :get, class: 'period-form-new' do |f| %>
        <div class="filter-buttons" role="group" aria-label="Opțiuni perioadă predefinite">
          <%= button_tag 'Azi', type: 'submit', name: 'period', value: 'today', class: "filter-btn #{@period == 'today' ? 'active' : ''}", aria: { pressed: @period == 'today', label: 'Filtrează date pentru astăzi' } %>
          <%= button_tag 'Săptămâna', type: 'submit', name: 'period', value: 'week', class: "filter-btn #{@period == 'week' ? 'active' : ''}", aria: { pressed: @period == 'week', label: 'Filtrează date pentru săptămâna curentă' } %>
          <%= button_tag 'Luna', type: 'submit', name: 'period', value: 'month', class: "filter-btn #{@period == 'month' ? 'active' : ''}", aria: { pressed: @period == 'month', label: 'Filtrează date pentru luna curentă' } %>
          <%= button_tag '7 zile', type: 'submit', name: 'period', value: '7', class: "filter-btn #{@period == '7' ? 'active' : ''}", aria: { pressed: @period == '7', label: 'Filtrează date pentru ultimele 7 zile' } %>
          <%= button_tag '30 zile', type: 'submit', name: 'period', value: '30', class: "filter-btn #{@period == '30' ? 'active' : ''}", aria: { pressed: @period == '30', label: 'Filtrează date pentru ultimele 30 zile' } %>
          <%= button_tag '90 zile', type: 'submit', name: 'period', value: '90', class: "filter-btn #{@period == '90' ? 'active' : ''}", aria: { pressed: @period == '90', label: 'Filtrează date pentru ultimele 90 zile' } %>
        </div>
        <div class="custom-filter" data-controller="analytics-date-filter" role="group" aria-label="Filtru perioadă personalizată">
          <%= f.date_field :custom_start_date, value: @custom_start_date, class: 'date-input-new', placeholder: 'De la', aria: { label: 'Data de început' }, data: { analytics_date_filter_target: 'startDate', action: 'change->analytics-date-filter#validateDates' } %>
          <%= f.date_field :custom_end_date, value: @custom_end_date, class: 'date-input-new', placeholder: 'Până la', aria: { label: 'Data de sfârșit' }, data: { analytics_date_filter_target: 'endDate', action: 'change->analytics-date-filter#validateDates' } %>
          <%= f.submit 'Aplică', class: 'btn-apply-new', aria: { label: 'Aplică filtru perioadă personalizată' }, data: { analytics_date_filter_target: 'applyButton', action: 'click->analytics-date-filter#handleApply' } %>
        </div>
      <% end %>
    </div>

    <!-- TIER 1: Hero KPIs (Always Visible) -->
    <div class="hero-kpis" role="region" aria-label="Indicatori cheie de performanță">
      <div class="kpi-card kpi-primary" role="article" aria-label="Total vizitatori">
        <div class="kpi-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path d="M4.5 6.375a4.125 4.125 0 118.25 0 4.125 4.125 0 01-8.25 0zM14.25 8.625a3.375 3.375 0 116.75 0 3.375 3.375 0 01-6.75 0zM3.087 17.87a.563.563 0 01.563-.563h6a.563.563 0 01.563.563 6.94 6.94 0 01-7.126 0z"/>
          </svg>
        </div>
        <div class="kpi-content">
          <div class="kpi-label" data-controller="tooltip" data-tooltip-text-value="Numărul total de vizite pe site, inclusiv vizitatori care revin">
            Total Vizitatori
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="tooltip-icon">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z" />
            </svg>
          </div>
          <div class="kpi-value"><%= number_with_delimiter(@total_visitors) %></div>
          <div class="kpi-trend <%= @visitors_change_pct >= 0 ? 'positive' : 'negative' %>">
            <%= @visitors_change_pct >= 0 ? '↑' : '↓' %> <%= @visitors_change_pct.abs %>% vs perioada anterioară
          </div>
        </div>
      </div>

      <div class="kpi-card kpi-success">
        <div class="kpi-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path fill-rule="evenodd" d="M7.5 6a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM3.751 20.105a8.25 8.25 0 0116.498 0 .75.75 0 01-.437.695A18.683 18.683 0 0112 22.5c-2.786 0-5.433-.608-7.812-1.7a.75.75 0 01-.437-.695z" clip-rule="evenodd" />
          </svg>
        </div>
        <div class="kpi-content">
          <div class="kpi-label" data-controller="tooltip" data-tooltip-text-value="Vizitatori distincti bazați pe cookie-uri. Un vizitator poate avea multiple vizite.">
            Vizitatori Unici
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="tooltip-icon">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z" />
            </svg>
          </div>
          <div class="kpi-value"><%= number_with_delimiter(@unique_visitors) %></div>
          <div class="kpi-trend <%= @unique_change_pct >= 0 ? 'positive' : 'negative' %>">
            <%= @unique_change_pct >= 0 ? '↑' : '↓' %> <%= @unique_change_pct.abs %>% vs perioada anterioară
          </div>
        </div>
      </div>

      <div class="kpi-card kpi-info">
        <div class="kpi-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path fill-rule="evenodd" d="M6.75 2.25A.75.75 0 017.5 3v1.5h9V3A.75.75 0 0118 3v1.5h.75a3 3 0 013 3v11.25a3 3 0 01-3 3H5.25a3 3 0 01-3-3V7.5a3 3 0 013-3H6V3a.75.75 0 01.75-.75zm13.5 9a1.5 1.5 0 00-1.5-1.5H5.25a1.5 1.5 0 00-1.5 1.5v7.5a1.5 1.5 0 001.5 1.5h13.5a1.5 1.5 0 001.5-1.5v-7.5z" clip-rule="evenodd" />
          </svg>
        </div>
        <div class="kpi-content">
          <div class="kpi-label">Medie Zilnică</div>
          <div class="kpi-value"><%= number_with_delimiter(@daily_average) %></div>
          <div class="kpi-trend <%= @daily_change_pct >= 0 ? 'positive' : 'negative' %>">
            <%= @daily_change_pct >= 0 ? '↑' : '↓' %> <%= @daily_change_pct.abs %>% vs perioada anterioară
          </div>
        </div>
      </div>

      <div class="kpi-card kpi-warning">
        <div class="kpi-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path fill-rule="evenodd" d="M11.54 22.351l.07.04.028.016a.76.76 0 00.723 0l.028-.015.071-.041a16.975 16.975 0 001.144-.742 19.58 19.58 0 002.683-2.282c1.944-1.99 3.963-4.98 3.963-8.827a8.25 8.25 0 00-16.5 0c0 3.846 2.02 6.837 3.963 8.827a19.58 19.58 0 002.682 2.282 16.975 16.975 0 001.145.742zM12 13.5a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
          </svg>
        </div>
        <div class="kpi-content">
          <div class="kpi-label">Top Locație</div>
          <div class="kpi-value-small"><%= @top_location ? @top_location[0] : 'N/A' %></div>
          <div class="kpi-trend <%= @location_change_pct >= 0 ? 'positive' : 'negative' %>">
            <%= @location_change_pct >= 0 ? '↑' : '↓' %> <%= @location_change_pct.abs %>% (<%= number_with_delimiter(@top_location ? @top_location[1] : 0) %> vizitatori)
          </div>
        </div>
      </div>

      <div class="kpi-card kpi-purple">
        <div class="kpi-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path fill-rule="evenodd" d="M19.902 4.098a3.75 3.75 0 00-5.304 0l-4.5 4.5a3.75 3.75 0 001.035 6.037.75.75 0 01-.646 1.353 5.25 5.25 0 01-1.449-8.45l4.5-4.5a5.25 5.25 0 117.424 7.424l-1.757 1.757a.75.75 0 11-1.06-1.06l1.757-1.757a3.75 3.75 0 000-5.304zm-7.389 4.267a.75.75 0 011-.353 5.25 5.25 0 011.449 8.45l-4.5 4.5a5.25 5.25 0 11-7.424-7.424l1.757-1.757a.75.75 0 111.06 1.06l-1.757 1.757a3.75 3.75 0 105.304 5.304l4.5-4.5a3.75 3.75 0 00-1.035-6.037.75.75 0 01-.354-1z" clip-rule="evenodd" />
          </svg>
        </div>
        <div class="kpi-content">
          <div class="kpi-label">Top Sursă</div>
          <div class="kpi-value-small"><%= @top_source[0] %></div>
          <div class="kpi-trend <%= @source_change_pct >= 0 ? 'positive' : 'negative' %>">
            <%= @source_change_pct >= 0 ? '↑' : '↓' %> <%= @source_change_pct.abs %>% (<%= number_with_delimiter(@top_source[1]) %> vizite)
          </div>
        </div>
      </div>

      <div class="kpi-card kpi-accent">
        <div class="kpi-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path d="M11.25 4.533A9.707 9.707 0 006 3a9.735 9.735 0 00-3.25.555.75.75 0 00-.5.707v14.25a.75.75 0 001 .707A8.237 8.237 0 016 18.75c1.995 0 3.823.707 5.25 1.886V4.533zM12.75 20.636A8.214 8.214 0 0118 18.75c.966 0 1.89.166 2.75.47a.75.75 0 001-.708V4.262a.75.75 0 00-.5-.707A9.735 9.735 0 0018 3a9.707 9.707 0 00-5.25 1.533v16.103z" />
          </svg>
        </div>
        <div class="kpi-content">
          <div class="kpi-label">Top Pagină</div>
          <div class="kpi-value-small"><%= @top_page[0] %></div>
          <div class="kpi-trend <%= @page_change_pct >= 0 ? 'positive' : 'negative' %>">
            <%= @page_change_pct >= 0 ? '↑' : '↓' %> <%= @page_change_pct.abs %>% (<%= number_with_delimiter(@top_page[1]) %> vizualizări)
          </div>
        </div>
      </div>
    </div>

    <!-- TIER 2: Daily Traffic Chart (Lazy Loaded) -->
    <%= turbo_frame_tag "daily_chart", src: dashboard_analytics_daily_chart_path(period: @period, custom_start_date: @custom_start_date, custom_end_date: @custom_end_date), loading: :lazy do %>
      <div class="loading-section">
        <div class="skeleton skeleton-text"></div>
        <div class="skeleton skeleton-chart"></div>
      </div>
    <% end %>

    <!-- TIER 3: Drill-Down Sections (Collapsible, Lazy Loaded) -->
    <div class="drill-down-sections">
      
      <!-- Geographic Distribution -->
      <details class="analytics-section">
        <summary class="section-header">
          <div class="section-title">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="section-icon">
              <path fill-rule="evenodd" d="M11.54 22.351l.07.04.028.016a.76.76 0 00.723 0l.028-.015.071-.041a16.975 16.975 0 001.144-.742 19.58 19.58 0 002.683-2.282c1.944-1.99 3.963-4.98 3.963-8.827a8.25 8.25 0 00-16.5 0c0 3.846 2.02 6.837 3.963 8.827a19.58 19.58 0 002.682 2.282 16.975 16.975 0 001.145.742zM12 13.5a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
            </svg>
            Distribuție Geografică
          </div>
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="chevron">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
          </svg>
        </summary>
        <%= turbo_frame_tag "geography", src: dashboard_analytics_geography_path(period: @period, custom_start_date: @custom_start_date, custom_end_date: @custom_end_date), loading: :lazy do %>
          <div class="loading-content">
            <div class="skeleton skeleton-table">
              <div class="skeleton skeleton-row"></div>
              <div class="skeleton skeleton-row"></div>
              <div class="skeleton skeleton-row"></div>
            </div>
          </div>
        <% end %>
      </details>

      <!-- Hourly Visits -->
      <details class="analytics-section">
        <summary class="section-header">
          <div class="section-title">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="section-icon">
              <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zM12.75 6a.75.75 0 00-1.5 0v6c0 .414.336.75.75.75h4.5a.75.75 0 000-1.5h-3.75V6z" clip-rule="evenodd" />
            </svg>
            Vizite pe Ore
          </div>
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="chevron">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
          </svg>
        </summary>
        <%= turbo_frame_tag "hourly", src: dashboard_analytics_hourly_path(period: @period, custom_start_date: @custom_start_date, custom_end_date: @custom_end_date), loading: :lazy do %>
          <div class="loading-content">
            <div class="skeleton skeleton-chart"></div>
          </div>
        <% end %>
      </details>

      <!-- Geographic Sources (Mixed) -->
      <details class="analytics-section">
        <summary class="section-header">
          <div class="section-title">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="section-icon">
              <path d="M21.721 12.752a9.711 9.711 0 00-.945-5.003 12.754 12.754 0 01-4.339 2.708 18.991 18.991 0 01-.214 4.772 17.165 17.165 0 005.498-2.477zM14.634 15.55a17.324 17.324 0 00.332-4.647c-.952.227-1.945.347-2.966.347-1.021 0-2.014-.12-2.966-.347a17.515 17.515 0 00.332 4.647 17.385 17.385 0 005.268 0zM9.772 17.119a18.963 18.963 0 004.456 0A17.182 17.182 0 0112 21.724a17.18 17.18 0 01-2.228-4.605zM7.777 15.23a18.87 18.87 0 01-.214-4.774 12.753 12.753 0 01-4.34-2.708 9.711 9.711 0 00-.944 5.004 17.165 17.165 0 005.498 2.477zM21.356 14.752a9.765 9.765 0 01-7.478 6.817 18.64 18.64 0 001.988-4.718 18.627 18.627 0 005.49-2.098zM2.644 14.752c1.682.971 3.53 1.688 5.49 2.099a18.64 18.64 0 001.988 4.718 9.765 9.765 0 01-7.478-6.816zM13.878 2.43a9.755 9.755 0 016.116 3.986 11.267 11.267 0 01-3.746 2.504 18.63 18.63 0 00-2.37-6.49zM12 2.276a17.152 17.152 0 012.805 7.121c-.897.23-1.837.353-2.805.353-.968 0-1.908-.122-2.805-.353A17.151 17.151 0 0112 2.276zM10.122 2.43a18.629 18.629 0 00-2.37 6.49 11.266 11.266 0 01-3.746-2.504 9.754 9.754 0 016.116-3.985z" />
            </svg>
            Surse & Geolocație
          </div>
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="chevron">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
          </svg>
        </summary>
        <%= turbo_frame_tag "geo_sources", src: dashboard_analytics_geo_sources_path(period: @period, custom_start_date: @custom_start_date, custom_end_date: @custom_end_date), loading: :lazy do %>
          <div class="loading-content">
            <div class="skeleton skeleton-table">
              <div class="skeleton skeleton-row"></div>
              <div class="skeleton skeleton-row"></div>
              <div class="skeleton skeleton-row"></div>
            </div>
          </div>
        <% end %>
      </details>

      <!-- Traffic Sources -->
      <details class="analytics-section">
        <summary class="section-header">
          <div class="section-title">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="section-icon">
              <path fill-rule="evenodd" d="M19.902 4.098a3.75 3.75 0 00-5.304 0l-4.5 4.5a3.75 3.75 0 001.035 6.037.75.75 0 01-.646 1.353 5.25 5.25 0 01-1.449-8.45l4.5-4.5a5.25 5.25 0 117.424 7.424l-1.757 1.757a.75.75 0 11-1.06-1.06l1.757-1.757a3.75 3.75 0 000-5.304zm-7.389 4.267a.75.75 0 011-.353 5.25 5.25 0 011.449 8.45l-4.5 4.5a5.25 5.25 0 11-7.424-7.424l1.757-1.757a.75.75 0 111.06 1.06l-1.757 1.757a3.75 3.75 0 105.304 5.304l4.5-4.5a3.75 3.75 0 00-1.035-6.037.75.75 0 01-.354-1z" clip-rule="evenodd" />
            </svg>
            Surse de Trafic
          </div>
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="chevron">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
          </svg>
        </summary>
        <%= turbo_frame_tag "sources", src: dashboard_analytics_sources_path(period: @period, custom_start_date: @custom_start_date, custom_end_date: @custom_end_date), loading: :lazy do %>
          <div class="loading-content">
            <div class="skeleton skeleton-table">
              <div class="skeleton skeleton-row"></div>
              <div class="skeleton skeleton-row"></div>
              <div class="skeleton skeleton-row"></div>
            </div>
          </div>
        <% end %>
      </details>

      <!-- Most Visited Pages -->
      <details class="analytics-section">
        <summary class="section-header">
          <div class="section-title">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="section-icon">
              <path d="M11.25 4.533A9.707 9.707 0 006 3a9.735 9.735 0 00-3.25.555.75.75 0 00-.5.707v14.25a.75.75 0 001 .707A8.237 8.237 0 016 18.75c1.995 0 3.823.707 5.25 1.886V4.533zM12.75 20.636A8.214 8.214 0 0118 18.75c.966 0 1.89.166 2.75.47a.75.75 0 001-.708V4.262a.75.75 0 00-.5-.707A9.735 9.735 0 0018 3a9.707 9.707 0 00-5.25 1.533v16.103z" />
            </svg>
            Cele Mai Vizitate Pagini
          </div>
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="chevron">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
          </svg>
        </summary>
        <%= turbo_frame_tag "pages", src: dashboard_analytics_pages_path(period: @period, custom_start_date: @custom_start_date, custom_end_date: @custom_end_date), loading: :lazy do %>
          <div class="loading-content">
            <div class="skeleton skeleton-table">
              <div class="skeleton skeleton-row"></div>
              <div class="skeleton skeleton-row"></div>
              <div class="skeleton skeleton-row"></div>
            </div>
          </div>
        <% end %>
      </details>

    </div>
  </div>

  <%= render 'admin/analytics/scripts' %>
<% else %>
  <%= render 'admin/no_access' %>
<% end %>
