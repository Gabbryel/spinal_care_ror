<%= turbo_frame_tag "daily_chart" do %>
  <div class="chart-section">
    <h3 class="chart-title">Trafic Zilnic</h3>
    <!-- Debug: <%= @daily_data.inspect %> -->
    <!-- Sum: <%= @daily_data.sum %> -->
    <% if @daily_data && @daily_data.any? && @daily_data.sum > 0 %>
      <canvas id="dailyTrafficChart" height="100"></canvas>
    <% else %>
      <div class="empty-state">
        <p>Nu există date disponibile pentru perioada selectată.</p>
        <small>Debug: Labels=<%= @daily_labels.count %>, Data=<%= @daily_data.count %>, Sum=<%= @daily_data.sum %></small>
      </div>
    <% end %>
  </div>

  <% if @daily_data && @daily_data.any? && @daily_data.sum > 0 %>
  <script>
    (function() {
      // Wait for Chart.js to be available
      const initChart = () => {
        if (typeof Chart === 'undefined') {
          setTimeout(initChart, 50);
          return;
        }

        const canvas = document.getElementById('dailyTrafficChart');
        if (!canvas) return;

        // Destroy existing chart instance if it exists
        if (canvas.chart) {
          canvas.chart.destroy();
        }

        const chartData = {
          labels: <%= raw @daily_labels.to_json %>,
          datasets: [{
            label: 'Vizite',
            data: <%= raw @daily_data.to_json %>,
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4,
            pointRadius: 4,
            pointHoverRadius: 6,
            pointBackgroundColor: '#3b82f6',
            pointBorderColor: '#fff',
            pointBorderWidth: 2
          }]
        };

        const chartConfig = {
          type: 'line',
          data: chartData,
          options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 3,
            interaction: {
              mode: 'index',
              intersect: false
            },
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12,
                titleFont: {
                  size: 14,
                  weight: 'bold'
                },
                bodyFont: {
                  size: 13
                },
                cornerRadius: 8
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  precision: 0,
                  font: {
                    size: 12
                  }
                },
                grid: {
                  color: '#e5e7eb'
                }
              },
              x: {
                ticks: {
                  maxRotation: 45,
                  minRotation: 45,
                  font: {
                    size: 11
                  }
                },
                grid: {
                  display: false
                }
              }
            }
          }
        };

        canvas.chart = new Chart(canvas, chartConfig);
      };

      initChart();
    })();
  </script>
  <% end %>

  <style>
    .chart-section {
      background: white;
      border-radius: 0.75rem;
      padding: 1.5rem;
      margin: 1rem 0;
    }

    .chart-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 1.5rem;
    }

    #dailyTrafficChart {
      width: 100% !important;
      height: auto !important;
    }
  </style>
<% end %>
