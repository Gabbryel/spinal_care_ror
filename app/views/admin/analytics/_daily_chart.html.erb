<%= turbo_frame_tag "daily_chart" do %>
  <div class="chart-section">
    <!-- DEBUG for Daily Chart -->
    <div style="background:#e7f3ff;border:2px solid #0066cc;padding:10px;margin-bottom:15px;border-radius:6px;font-family:monospace;font-size:11px;">
      <strong style="color:#0066cc;display:block;margin-bottom:8px;">ðŸ“Š DAILY CHART DEBUG</strong>
      <table style="width:100%;font-size:11px;">
        <tr><td style="padding:2px;"><strong>Period param:</strong></td><td style="padding:2px;"><%= params[:period].inspect %></td></tr>
        <tr><td style="padding:2px;"><strong>Start date (chart):</strong></td><td style="padding:2px;color:#dc3545;font-weight:bold;"><%= @start_date.strftime('%d.%m.%Y %H:%M:%S') rescue 'ERROR' %></td></tr>
        <tr><td style="padding:2px;"><strong>End date (chart):</strong></td><td style="padding:2px;color:#dc3545;font-weight:bold;"><%= @end_date.strftime('%d.%m.%Y %H:%M:%S') rescue 'ERROR' %></td></tr>
        <tr><td style="padding:2px;"><strong>Labels count:</strong></td><td style="padding:2px;"><%= @daily_labels.count %></td></tr>
        <tr><td style="padding:2px;"><strong>Labels array:</strong></td><td style="padding:2px;color:#0066cc;"><%= @daily_labels.inspect %></td></tr>
        <tr><td style="padding:2px;"><strong>Data array:</strong></td><td style="padding:2px;"><%= @daily_data.inspect %></td></tr>
        <tr><td style="padding:2px;"><strong>Data sum:</strong></td><td style="padding:2px;"><%= @daily_data.sum %></td></tr>
        <tr><td style="padding:2px;color:#28a745;"><strong>EXPECTED (3d):</strong></td><td style="padding:2px;color:#28a745;"><%= (Time.zone.now.end_of_day - 3.days).beginning_of_day.strftime('%d.%m.%Y') %> - <%= Time.zone.now.end_of_day.strftime('%d.%m.%Y') %></td></tr>
      </table>
    </div>
    
    <h3 class="chart-title">Trafic Zilnic</h3>
    <!-- Debug: <%= @daily_data.inspect %> -->
    <!-- Sum: <%= @daily_data.sum %> -->
    <% if @daily_data && @daily_data.any? && @daily_data.sum > 0 %>
      <canvas id="dailyTrafficChart" height="100"></canvas>
    <% else %>
      <div class="empty-state">
        <p>Nu existÄƒ date disponibile pentru perioada selectatÄƒ.</p>
        <small>Debug: Labels=<%= @daily_labels.count %>, Data=<%= @daily_data.count %>, Sum=<%= @daily_data.sum %></small>
      </div>
    <% end %>
  </div>

  <% if @daily_data && @daily_data.any? && @daily_data.sum > 0 %>
  <script>
    (function() {
      // Wait for Chart.js to be available
      const initChart = () => {
        if (typeof Chart === 'undefined') {
          setTimeout(initChart, 50);
          return;
        }

        const canvas = document.getElementById('dailyTrafficChart');
        if (!canvas) return;

        // Destroy existing chart instance if it exists
        if (canvas.chart) {
          canvas.chart.destroy();
        }

        const chartData = {
          labels: <%= raw @daily_labels.to_json %>,
          datasets: [{
            label: 'Vizite',
            data: <%= raw @daily_data.to_json %>,
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4,
            pointRadius: 4,
            pointHoverRadius: 6,
            pointBackgroundColor: '#3b82f6',
            pointBorderColor: '#fff',
            pointBorderWidth: 2
          }]
        };

        const chartConfig = {
          type: 'line',
          data: chartData,
          options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 3,
            interaction: {
              mode: 'index',
              intersect: false
            },
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12,
                titleFont: {
                  size: 14,
                  weight: 'bold'
                },
                bodyFont: {
                  size: 13
                },
                cornerRadius: 8
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  precision: 0,
                  font: {
                    size: 12
                  }
                },
                grid: {
                  color: '#e5e7eb'
                }
              },
              x: {
                ticks: {
                  maxRotation: 45,
                  minRotation: 45,
                  font: {
                    size: 11
                  }
                },
                grid: {
                  display: false
                }
              }
            }
          }
        };

        canvas.chart = new Chart(canvas, chartConfig);
      };

      initChart();
    })();
  </script>
  <% end %>
<% end %>
