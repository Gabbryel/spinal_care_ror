<%= turbo_frame_tag "geo_sources" do %>
  <% if @geo_sources.any? || @top_sources.any? || @top_locations.any? %>
  <div class="geography-section">
    <!-- Filter Status Indicator -->
    <% filter_bots = params[:filter_bots] != 'false' %>
    <% filter_geography = params[:filter_geography] == 'true' %>
    <% if filter_bots || filter_geography %>
      <div style="margin-bottom: 1rem; padding: 0.75rem; background: #ecfdf5; border: 1px solid #10b981; border-radius: 8px; font-size: 0.875rem; color: #047857; display: flex; align-items: center; gap: 0.5rem;">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" style="width: 1.25rem; height: 1.25rem; flex-shrink: 0;">
          <path fill-rule="evenodd" d="M10 1a4.5 4.5 0 00-4.5 4.5V9H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-.5V5.5A4.5 4.5 0 0010 1zm3 8V5.5a3 3 0 10-6 0V9h6z" clip-rule="evenodd" />
        </svg>
        <span><strong>Filtre active:</strong> <%= filter_bots ? 'âœ“ Bots excluse' : '' %><%= filter_bots && filter_geography ? ' â€¢ ' : '' %><%= filter_geography ? 'âœ“ Doar RomÃ¢nia + Vecini' : '' %></span>
      </div>
    <% end %>
    
    <!-- Summary Stats -->
    <div class="stats-grid" style="margin-bottom: 2rem;">
      <div class="stat-card">
        <div class="stat-label">Vizite cu GeolocaÈ›ie</div>
        <div class="stat-value"><%= number_with_delimiter(@total_geo_visits) %></div>
      </div>
      <div class="stat-card stat-success">
        <div class="stat-label">Top SursÄƒ</div>
        <div class="stat-value"><%= @top_sources.first ? @top_sources.first[:source].truncate(20) : 'N/A' %></div>
        <div class="stat-meta"><%= @top_sources.first ? number_with_delimiter(@top_sources.first[:visits]) : 0 %> vizite</div>
      </div>
      <div class="stat-card stat-info">
        <div class="stat-label">Top LocaÈ›ie</div>
        <div class="stat-value"><%= @top_locations.first ? @top_locations.first[:city] : 'N/A' %></div>
        <div class="stat-meta"><%= @top_locations.first ? number_with_delimiter(@top_locations.first[:visits]) : 0 %> vizite</div>
      </div>
    </div>

    <!-- Top Sources & Locations Grid -->
    <div class="geo-grid">
      <!-- Top Sources -->
      <div class="geo-table-container">
        <h4 class="geo-table-title">Top Surse de Trafic</h4>
        <table class="geo-table">
          <thead>
            <tr>
              <th>SursÄƒ</th>
              <th>Vizite</th>
            </tr>
          </thead>
          <tbody>
            <% @top_sources.each do |source| %>
              <tr>
                <td class="city-name">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="location-icon">
                    <path fill-rule="evenodd" d="M19.902 4.098a3.75 3.75 0 00-5.304 0l-4.5 4.5a3.75 3.75 0 001.035 6.037.75.75 0 01-.646 1.353 5.25 5.25 0 01-1.449-8.45l4.5-4.5a5.25 5.25 0 117.424 7.424l-1.757 1.757a.75.75 0 11-1.06-1.06l1.757-1.757a3.75 3.75 0 000-5.304zm-7.389 4.267a.75.75 0 011-.353 5.25 5.25 0 011.449 8.45l-4.5 4.5a5.25 5.25 0 11-7.424-7.424l1.757-1.757a.75.75 0 111.06 1.06l-1.757 1.757a3.75 3.75 0 105.304 5.304l4.5-4.5a3.75 3.75 0 00-1.035-6.037.75.75 0 01-.354-1z" clip-rule="evenodd" />
                  </svg>
                  <%= source[:source].truncate(35) %>
                </td>
                <td class="city-count"><%= number_with_delimiter(source[:visits]) %></td>
              </tr>
            <% end %>
            <% if @top_sources.empty? %>
              <tr>
                <td colspan="2" class="empty-state">Nu existÄƒ date disponibile</td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <!-- Top Locations -->
      <div class="geo-table-container">
        <h4 class="geo-table-title">Top LocaÈ›ii</h4>
        <table class="geo-table">
          <thead>
            <tr>
              <th>OraÈ™, ÈšarÄƒ</th>
              <th>Vizite</th>
            </tr>
          </thead>
          <tbody>
            <% @top_locations.each do |location| %>
              <tr>
                <td class="city-name">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="location-icon">
                    <path fill-rule="evenodd" d="M9.69 18.933l.003.001C9.89 19.02 10 19 10 19s.11.02.308-.066l.002-.001.006-.003.018-.008a5.741 5.741 0 00.281-.14c.186-.096.446-.24.757-.433.62-.384 1.445-.966 2.274-1.765C15.302 14.988 17 12.493 17 9A7 7 0 103 9c0 3.492 1.698 5.988 3.355 7.584a13.731 13.731 0 002.273 1.765 11.842 11.842 0 00.976.544l.062.029.018.008.006.003zM10 11.25a2.25 2.25 0 100-4.5 2.25 2.25 0 000 4.5z" clip-rule="evenodd" />
                  </svg>
                  <div>
                    <div><%= location[:city] %></div>
                    <div style="font-size: 0.75rem; color: #6b7280; margin-top: 2px;"><%= location[:country] %></div>
                  </div>
                </td>
                <td class="city-count"><%= number_with_delimiter(location[:visits]) %></td>
              </tr>
            <% end %>
            <% if @top_locations.empty? %>
              <tr>
                <td colspan="2" class="empty-state">Nu existÄƒ date disponibile</td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Combined Source + Location Table -->
    <div class="geo-table-container" style="margin-top: 2rem;" data-controller="table-filter">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h4 class="geo-table-title" style="margin: 0;">Trafic Combinat: SursÄƒ Ã— LocaÈ›ie</h4>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
          <input 
            type="text" 
            placeholder="ðŸ” CautÄƒ sursÄƒ, oraÈ™, È›arÄƒ..." 
            data-table-filter-target="searchInput"
            data-action="input->table-filter#filterTable"
            style="padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem; width: 250px;"
          />
          <button 
            data-action="click->table-filter#clearFilter"
            style="padding: 0.5rem 0.75rem; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem; cursor: pointer; display: none;"
            data-table-filter-target="clearButton"
          >
            âœ• È˜terge
          </button>
        </div>
      </div>
      <table class="geo-table" data-table-filter-target="table">
        <thead>
          <tr>
            <th>SursÄƒ</th>
            <th>OraÈ™</th>
            <th>ÈšarÄƒ</th>
            <th>Vizite</th>
          </tr>
        </thead>
        <tbody data-table-filter-target="tbody">
          <% @geo_sources.first(50).each do |row| %>
            <tr data-table-filter-target="row" 
                data-source="<%= row[:source].downcase %>" 
                data-city="<%= row[:city].downcase %>" 
                data-country="<%= row[:country].downcase %>">
              <td class="city-name">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="location-icon">
                  <path fill-rule="evenodd" d="M19.902 4.098a3.75 3.75 0 00-5.304 0l-4.5 4.5a3.75 3.75 0 001.035 6.037.75.75 0 01-.646 1.353 5.25 5.25 0 01-1.449-8.45l4.5-4.5a5.25 5.25 0 117.424 7.424l-1.757 1.757a.75.75 0 11-1.06-1.06l1.757-1.757a3.75 3.75 0 000-5.304zm-7.389 4.267a.75.75 0 011-.353 5.25 5.25 0 011.449 8.45l-4.5 4.5a5.25 5.25 0 11-7.424-7.424l1.757-1.757a.75.75 0 111.06 1.06l-1.757 1.757a3.75 3.75 0 105.304 5.304l4.5-4.5a3.75 3.75 0 00-1.035-6.037.75.75 0 01-.354-1z" clip-rule="evenodd" />
                </svg>
                <%= row[:source].truncate(35) %>
              </td>
              <td><%= row[:city] %></td>
              <td><%= row[:country] %></td>
              <td class="city-count"><%= number_with_delimiter(row[:visits]) %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
      <div data-table-filter-target="emptyState" style="display: none; padding: 2rem; text-align: center; color: #6b7280; font-size: 0.875rem;">
        Nu s-au gÄƒsit rezultate pentru cÄƒutarea ta.
      </div>
    </div>
  </div>
  <% else %>
  <div class="empty-state">
    <p>Nu existÄƒ date de geolocaÈ›ie disponibile pentru perioada selectatÄƒ.</p>
  </div>
  <% end %>
<% end %>
