<div class="medical-service-form">
  <%= simple_form_for(medical_service, id: (medical_service.id ? "edit_medical_service_#{medical_service.id}" : dom_id(MedicalService.new)), html: { data: { turbo: false } }) do |f| %>
    <% if medical_service.errors.any? %>
      <div class="form-error-message">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
        </svg>
        <%= medical_service.errors.full_messages.to_sentence.capitalize %>
      </div>
    <% end %>

    <div class="form-section">
      <h3 class="form-section-title">Informații generale</h3>
      
      <div class="form-group">
        <%= f.label :name, 'Nume serviciu medical *', class: 'form-label' %>
        <%= f.input :name, label: false, placeholder: 'Ex: Consultație ortopedică', wrapper_html: { class: 'form-input-wrapper' } %>
      </div>

      <div class="form-group">
        <%= f.label :specialty_id, 'Specialitate medicală *', class: 'form-label' %>
        <% if defined?(@specialty) && @specialty.persisted? %>
          <%= f.association :specialty, 
              collection: [@specialty],
              selected: @specialty.id,
              disabled: true,
              value_method: :id, 
              label: false,
              wrapper_html: { class: 'form-input-wrapper' } %>
          <%= f.hidden_field :specialty_id, value: @specialty.id %>
          <p class="form-hint">Serviciul va fi adăugat la specialitatea: <%= @specialty.name %></p>
        <% else %>
          <%= f.association :specialty, 
              order: :name, 
              value_method: :id, 
              label: false, 
              prompt: 'Selectează specialitatea',
              wrapper_html: { class: 'form-input-wrapper' } %>
        <% end %>
      </div>

      <div class="form-group">
        <%= f.label :member_id, 'Specialist asociat', class: 'form-label' %>
        <% 
          # Filter members based on context
          if defined?(@specialty) && @specialty.persisted?
            # On specialty admin page - only show members from this specialty
            member_collection = Member.where(specialty_id: @specialty.id)
                                     .where(has_prices: true)
                                     .order(:last_name, :first_name)
            hint_text = "Selectează un specialist din #{@specialty.name} sau lasă necompletat pentru servicii generale"
          else
            # On general medical services page - show all members
            member_collection = Member.all.select { |m| m.has_prices }.sort_by { |m| m.specialty_name }
            hint_text = "Lasă necompletat pentru servicii generale"
          end
        %>
        <%= f.association :member, 
            collection: member_collection, 
            label_method: :form_label, 
            value_method: :id, 
            label: false, 
            prompt: 'Opțional - selectează specialistul',
            wrapper_html: { class: 'form-input-wrapper' } %>
        <p class="form-hint"><%= hint_text %></p>
      </div>

      <div class="form-group">
        <%= f.label :price, 'Preț (lei)', class: 'form-label' %>
        <%= f.input :price, label: false, placeholder: '0 = La telefon', wrapper_html: { class: 'form-input-wrapper' } %>
        <p class="form-hint">Introdu 0 pentru afișarea "La telefon"</p>
      </div>

      <div class="form-group form-checkbox">
        <%= f.input :has_day_hospitalization, 
            as: :boolean,
            label: 'Serviciu disponibil în spitalizare de zi' %>
      </div>
    </div>

    <div class="form-section">
      <h3 class="form-section-title">Descriere</h3>
      <%= f.rich_text_area :description, 
          placeholder: 'Scrie detalii despre serviciul medical oferit, procedura, durată, etc...' %>
    </div>

    <div class="form-actions">
      <button type="button" class="btn-cancel" data-bs-dismiss="modal">Anulează</button>
      <%= f.submit 'Salvează', class: 'btn-submit' %>
    </div>
  <% end %>
</div>

<script>
  // Prevent modal flicker on form submit by hiding modal immediately
  (function() {
    document.addEventListener('DOMContentLoaded', function() {
      const forms = document.querySelectorAll('.medical-service-form form');
      forms.forEach(form => {
        form.addEventListener('submit', function(e) {
          const modal = this.closest('.modal');
          if (modal) {
            // Immediately hide modal to prevent flicker during redirect
            modal.style.display = 'none';
            modal.classList.remove('show');
            document.body.classList.remove('modal-open');
            document.body.style.removeProperty('overflow');
            document.body.style.removeProperty('padding-right');
            
            // Remove backdrop
            const backdrop = document.querySelector('.modal-backdrop');
            if (backdrop) {
              backdrop.remove();
            }
          }
        });
      });
    });
    
    // Also listen for Turbo events in case page loads via Turbo
    document.addEventListener('turbo:load', function() {
      const forms = document.querySelectorAll('.medical-service-form form');
      forms.forEach(form => {
        if (form.dataset.listenerAdded) return;
        form.dataset.listenerAdded = 'true';
        
        form.addEventListener('submit', function(e) {
          const modal = this.closest('.modal');
          if (modal) {
            modal.style.display = 'none';
            modal.classList.remove('show');
            document.body.classList.remove('modal-open');
            document.body.style.removeProperty('overflow');
            document.body.style.removeProperty('padding-right');
            
            const backdrop = document.querySelector('.modal-backdrop');
            if (backdrop) backdrop.remove();
          }
        });
      });
    });
  })();
</script>